# 🚨 Pikud Haoref Alert Scanner

סקריפט Node.js לסריקת התראות פיקוד העורף בישראל באמצעות API הרשמי.

## ✨ תכונות

✅ **סריקה אוטומטית** - סורק התראות כל 3 שניות  
✅ **API רשמי** - משתמש ב-pikud-haoref-api (הספרייה הרשמית)  
✅ **שליחת התראות TELNET** - שולח אוטומטית התראות לתחנות כבאות דרך TELNET  
✅ **ניהול תחנות** - קורא תחנות כבאות מקובץ Excel ומאתר תחנות מושפעות לפי פוליגונים  
✅ **יצירת Excel** - יצוא כל התראות לקובץ Excel עם גליונות נפרדים  
✅ **סוגי התראות** - 17 סוגי התראות רשמיים:
  - `missiles` - התראות טילים ורקטות
  - `earthQuake` - רעידות אדמה
  - `tsunami` - צונמי
  - `hazardousMaterials` - חומרים מסוכנים
  - `terroristInfiltration` - חדירת טרוריסטים
  - `radiologicalEvent` - אירוע רדיולוגי
  - `hostileAircraftIntrusion` - פלישת כלי טיס עוינים
  - `newsFlash` - הודעות חוזרות לשיוך מקלט
  - וגם גרסאות התרגיל (Drill) של כל סוג
  - `none` - ללא התראה פעילה

## 📋 דרישות

- Node.js 14.0.0 ו-npm
- **חשוב**: חייב להיות מופעל מישראל או עם פרוקסי ישראלי
- קובץ Excel עם רשימת תחנות כבאות (ראה מבנה קובץ למטה)
- גישה לרשת הפנימית עם שרתי TELNET (100.71.0.249, 100.71.0.246, 100.71.0.243)

## 🚀 התקנה והרצה

### 1. התקנת תלויות

```bash
npm install
```

או ידנית:

```bash
npm install pikud-haoref-api exceljs
```

### 2. הכנת קובץ התחנות

ודא שקיים קובץ Excel בשם `עותק של רשימת תחנות - אזורי פקע''ר - מעודכן.xlsx` בתיקיית הפרויקט.

**מבנה הקובץ:**
- עמודה A: מס"ד
- עמודה B: מחוז
- עמודה C: תחנה אזורית
- עמודה D: סוג תחנה
- עמודה E: שם תחנה
- עמודה F: כתובת מלאה
- **עמודה G: פוליגון פיקוד העורף** (חשוב!)
- **עמודה H: מחוז שרת** (A/B/C - לשליחת TELNET)
- **עמודה I: קוד API** (מספר התחנה, לדוגמה: 121, 129)

### 3. הרצת הסקריפט

#### ריצה עד הפסקה ידנית (Ctrl+C):
```bash
npm start
# או
node scanner.js
```

#### ריצה עם משך זמן מגביל (בשניות):
```bash
node scanner.js 60
```

#### ריצה ללא שליחת TELNET (לבדיקות):
ערוך את `scanner.js` ושינוי `enableTelnet: true` ל-`enableTelnet: false`

### 4. תפוקה

הסקריפט ייצור קובץ Excel בשם:
```
pikud_alerts_YYYYMMDD_HHMMSS.xlsx
```

לדוגמה: `pikud_alerts_20251202_131752.xlsx`

## 🔔 שליחת התראות TELNET

כשמגיעה התראה מפיקוד העורף, המערכת:

1. **מאתרת תחנות מושפעות** - לפי הערים מההתראה והפוליגונים בקובץ האקסל
2. **שולחת פקודת TELNET** - לכל תחנה רלוונטית לפי השרת שלה (A/B/C)
3. **מדווחת על התוצאות** - מציגה כמה תחנות נפגעו וכמה התראות נשלחו בהצלחה

**מבנה פקודת TELNET:**
- פורמט: `$GMNG[מספר_תחנה] L[קוד_התראה]`
- דוגמה: `$GMNG122 L00101` (תחנה 122, התראת טילים)

**שרתי TELNET:**
- **A** (100.71.0.249): דן מרכז ונציבות
- **B** (100.71.0.246): יו"ש צפון וירושלים  
- **C** (100.71.0.243): חוף ודרום

**פורטים:** 10000, 10001, 10002, 61113 (נסיון אוטומטי בכל הפורטים)

**מיפוי קודי התראות (רק 4 קודים פעילים):**
- 00112 - ירי רקטות וטילים (missiles)
- 00110 - רעידת אדמה (earthQuake)
- 00111 - חדירת כלי טייס עוין (hostileAircraftIntrusion)
- 00113 - התרעה מקדימה (newsFlash)

**הערה:** שאר סוגי ההתראות (צונמי, חומרים מסוכנים, וכו') לא נשלחים דרך TELNET

## 📊 מבנה קובץ ה-Excel

הקובץ מכיל 17 גליונות (אחד לכל סוג התראה):

| גליון | תוכן |
|------|------|
| `missiles` | התראות טילים ורקטות |
| `earthQuake` | רעידות אדמה |
| `tsunami` | צונמי |
| `hazardousMaterials` | חומרים מסוכנים |
| `terroristInfiltration` | חדירת טרוריסטים |
| `radiologicalEvent` | אירוע רדיולוגי |
| `hostileAircraftIntrusion` | פלישת כלי טיס |
| `newsFlash` | הודעות חוזרות |
| `[Type]Drill` | גרסאות התרגיל |
| `none` | ללא התראה |

### עמודות בכל גליון:

| עמודה | תיאור |
|------|------|
| זמן | זמן הסריקה (בפורמט ישראלי) |
| סוג התראה | סוג ההתראה |
| ערים | הערים המופגעות |
| הוראות | ההוראות לאזרחים |
| TELNET נשלח | האם נשלח TELNET והתוצאות |
| תחנות מושפעות | רשימת התחנות שהושפעו מההתראה |
| נתונים גולמיים | הנתונים המלאים בפורמט JSON |

### דוגמא של התראה (missiles):

```javascript
{
  type: 'missiles',
  cities: ['תל אביב - מזרח', 'חיפה - כרמל ועיר תחתית'],
  instructions: 'היכנסו למבנה, נעלו את הדלתות וסגרו את החלונות'
}
```

### דוגמא ללא התראה:

```javascript
{
  type: 'none',
  cities: []
}
```

## 🔧 דוגמות שימוש

### דוגמה 1: ריצה בסיסית

```bash
$ npm start
============================================================
🚨 PIKUD HAOREF ALERT SCANNER 🚨
============================================================
Start time: 02/12/2025, 13:14:05

✅ Scanner initialized
Alert types being tracked: 17 types

🚨 Starting alert scanner (interval: 3 seconds)...
Press Ctrl+C to stop scanning and generate Excel file

[02/12/2025, 13:14:08] 🔔 Alert detected → Type: missiles
    🏙️  Cities: תל אביב - מזרח, חיפה

🔍 מחפש תחנות מושפעות...
    ✅ נמצאו 5 תחנות מושפעות:
       - בני ברק (דן) - קוד: 121
       - גבעתיים (דן) - קוד: 124
       - הרצליה (דן) - קוד: 125

📡 שולח התראה מסוג "missiles" ל-5 תחנות...

🎯 תחנה: בני ברק (דן)
   קוד API: 121, שרת: A
  🔌 מחובר ל-100.71.0.249:10000
  📤 נשלח: $GMNG121 L00101
   ✅ נשלח בהצלחה

📊 סיכום שליחה: 5 הצלחות, 0 כשלונות

[02/12/2025, 13:14:11] Scan #3: No active alerts
```

### דוגמה 2: ריצה עם משך זמן מגביל

```bash
$ node scanner.js 30
```

## 🐛 פתרון בעיות

### שגיאה: `Cannot find module 'pikud-haoref-api'`
```bash
npm install pikud-haoref-api exceljs
```

### שגיאה: API לא זמין (מחוץ לישראל)

הספרייה זקוקה לגישה מישראל. אפשרויות:
1. הרץ את הסקריפט על מכונה בישראל
2. השתמש בפרוקסי ישראלי
3. בקש ממשתמש בישראל להפעיל את הסקריפט

### שגיאה: קובץ התחנות לא נמצא

ודא שקובץ האקסל `עותק של רשימת תחנות - אזורי פקע''ר - מעודכן.xlsx` נמצא בתיקיית הפרויקט.

### שגיאה: חיבור TELNET נכשל

בדוק:
1. האם יש גישה לרשת הפנימית עם שרתי TELNET?
2. האם השרתים (100.71.0.249, 100.71.0.246, 100.71.0.243) זמינים?
3. האם הפורטים (10000-10002, 61113) פתוחים?
4. האם קודי התחנות (עמודה I) תקינים?

### Node.js לא מותקן

הורד מ: https://nodejs.org/

## 📝 הערות

- הסקריפט מתעדכן אוטומטית כל 3 שניות
- אם API לא זמין, הסקריפט ממשיך ומנסה שוב בעוד 3 שניות
- ניתן לעצור בכל עת באמצעות `Ctrl+C`
- כל ההתראות משמורות בזיכרון עד לסיום הריצה
- קובץ ה-Excel מיוצר רק בסיום הריצה
- התראות כפולות נמנעות (לא נשלח TELNET פעמיים לאותה התראה)
- חיפוש תחנות מבוסס על התאמה חלקית של שמות ערים בפוליגונים
- המערכת מנסה לשלוח לכל הפורטים עד שאחד מצליח

## 📚 מקורות

- [pikud-haoref-api](https://github.com/eladcn/pikud-haoref-api) - הספרייה הרשמית
- [ExcelJS](https://github.com/exceljs/exceljs) - ספרייה לעבודה עם Excel
- [Pikud Haoref](https://www.oref.org.il/) - אתר פיקוד העורף

## 📁 מבנה הקבצים

```
NotiSystem-main/
├── scanner.js              # הסקריפט הראשי
├── stationManager.js       # ניהול תחנות כבאות (קריאת אקסל)
├── telnetClient.js         # שליחת פקודות TELNET
├── package.json            # תלויות הפרויקט
├── README.md               # המדריך הזה
└── עותק של רשימת תחנות - אזורי פקע''ר - מעודכן.xlsx  # קובץ התחנות
```

---

**פרויקט**: NotiSystem  
**גרסה**: 2.0  
**שפה**: Node.js  
**תאריך**: 2025-12-22